public with sharing class TestDriveSlotGenerator {

    public TestDriveSlotGenerator() {
    }

    public static void generateSlots(Date startDate, Integer numberOfDays) {

        List<Flagship_Store__c> stores = [
            SELECT Id, Name, Opening_Time__c, Closing_Time__c 
            FROM Flagship_Store__c 
            WHERE AvailableModles__c != null
        ];

        List<VehicleModel__c> models = [
            SELECT Id, Name, DriveMethod__c, EligibleStore__c 
            FROM VehicleModel__c 
            WHERE AllowTestDrive__c = TRUE
        ];

        for (VehicleModel__c model : models) {
            System.debug('ëª¨ë¸ ID: ' + model.Id + ', ì´ë¦„: ' + model.Name);
        }

        //Junction objectì—ì„œ ë§¤í•‘ ê°€ì ¸ì˜¤ê¸°
        List<VehicleModelStore__c> modelStoreLinks = [
            SELECT VehicleModel__c, FlagshipStore__c 
            FROM VehicleModelStore__c
        ];
    
        // ëª¨ë¸ë³„ í—ˆìš© ë§¤ì¥ ë§µ ìƒì„±
        Map<Id, Set<Id>> modelToStores = new Map<Id, Set<Id>>();
        for (VehicleModelStore__c link : modelStoreLinks) {
            if (!modelToStores.containsKey(link.VehicleModel__c)) {
                modelToStores.put(link.VehicleModel__c, new Set<Id>());
            }
            modelToStores.get(link.VehicleModel__c).add(link.FlagshipStore__c);
            System.debug(modelToStores);
        }

        List<TestDriveStaff__c> staffList = [
            SELECT Id, Name, AssignedFlagshipStore__c, WorkStart__c, WorkEnd__c, OffDays__c 
            FROM TestDriveStaff__c 
            WHERE AssignedFlagshipStore__c != null
        ];

        // ì§ì›ë³„ ë°°ì • ê°€ëŠ¥í•œ ë§¤ì¥ ë§µ ìƒì„± (ê¸°ì¡´ ë°°ì • + ì¶”ê°€ ë°°ì • ê°€ëŠ¥ ë§¤ì¥)
        Map<Id, List<Id>> staffToAvailableStores = new Map<Id, List<Id>>();
        
        // ê° ì§ì›ì˜ ê¸°ì¡´ ë°°ì • ë§¤ì¥ê³¼ ì¶”ê°€ ë°°ì • ê°€ëŠ¥í•œ ë§¤ì¥ë“¤ì„ ìˆ˜ì§‘
        for (TestDriveStaff__c staff : staffList) {
            List<Id> availableStores = new List<Id>();
            
            // ê¸°ì¡´ ë°°ì • ë§¤ì¥ ì¶”ê°€
            if (staff.AssignedFlagshipStore__c != null) {
                availableStores.add(staff.AssignedFlagshipStore__c);
            }
            
            // ì¶”ê°€ë¡œ ë°°ì • ê°€ëŠ¥í•œ ë§¤ì¥ë“¤ (ëª¨ë“  ë§¤ì¥ì—ì„œ ëœë¤ ì„ íƒ)
            for (Flagship_Store__c store : stores) {
                if (!availableStores.contains(store.Id)) {
                    availableStores.add(store.Id);
                }
            }
            
            staffToAvailableStores.put(staff.Id, availableStores);
        }

        List<TestDriveSlot__c> slotsToInsert = new List<TestDriveSlot__c>();

        for (Integer i = 0; i < numberOfDays; i++) {
            Date currentDate = startDate.addDays(i);
            DateTime dt = DateTime.newInstance(currentDate, Time.newInstance(0, 0, 0, 0));
            Integer dow = dt.format('u', 'en_US').isNumeric() ? Integer.valueOf(dt.format('u', 'en_US')) : 1;
            // u = ISO day of week (1=Monday, 7=Sunday)
            String[] dayCodes = new List<String>{'MON','TUE','WED','THU','FRI','SAT','SUN'};
            String dayCode = dayCodes[dow - 1];
            
            for (VehicleModel__c model : models) {
                for (Flagship_Store__c store : stores) {
                    
                    if (!modelToStores.containsKey(model.Id)) continue;
                    if (!modelToStores.get(model.Id).contains(store.Id)) continue;

                    System.debug('Store: ' + store.Id + ', Name: ' + store.Name);
                    System.debug('modelToStores: ' + modelToStores.get(model.Id));

                    if (!modelToStores.containsKey(model.Id)) {
                        System.debug('ëª¨ë¸ ' + model.Name + ' ì€ ì–´ë–¤ ë§¤ì¥ì—ë„ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŒ');
                        continue;
                    }
            
                    // í•´ë‹¹ ë§¤ì¥ì— ë°°ì • ê°€ëŠ¥í•œ ì§ì›ë“¤ì„ ì°¾ê¸°
                    List<TestDriveStaff__c> availableStaffForStore = new List<TestDriveStaff__c>();
                    for (TestDriveStaff__c staff : staffList) {
                        List<Id> staffStores = staffToAvailableStores.get(staff.Id);
                        if (staffStores != null && staffStores.contains(store.Id)) {
                            // íœ´ë¬´ì¼ ì²´í¬
                            if (staff.OffDays__c != null && staff.OffDays__c.contains(dayCode)) continue;
                            availableStaffForStore.add(staff);
                        }
                    }
                    
                    // ì§ì›ì´ ì—†ìœ¼ë©´ ë‹¤ìŒ ë§¤ì¥ìœ¼ë¡œ
                    if (availableStaffForStore.isEmpty()) continue;
                    
                    // ë§¤ì¥ë³„ë¡œ ì§ì›ì„ ëœë¤í•˜ê²Œ ì„ íƒ (ê· ë“± ë¶„ë°°)
                    Integer staffIndex = Math.mod(i + Math.mod(store.Id.hashCode(), availableStaffForStore.size()), availableStaffForStore.size());
                    TestDriveStaff__c selectedStaff = availableStaffForStore[staffIndex];
                    
                    System.debug('ë§¤ì¥: ' + store.Name + ' / ì„ íƒëœ ì§ì›: ' + selectedStaff.Name + ' / ë§¤ì¥ID: ' + store.Id + ' / ì§ì›ë°°ì •ë§¤ì¥: ' + selectedStaff.AssignedFlagshipStore__c);

                    // ì‹œê°„ ë£¨í”„
                    Time slotStart = selectedStaff.WorkStart__c;
                    Time slotEnd = selectedStaff.WorkEnd__c;

                    // â• ì‹œì‘/ì¢…ë£Œ ë²”ìœ„ ì¡°ì •
                    Time dayStart = Time.newInstance(10, 0, 0, 0);
                    Time dayEnd = Time.newInstance(18, 0, 0, 0);
                    Time lunchStart = Time.newInstance(12, 0, 0, 0);
                    Time lunchEnd = Time.newInstance(13, 0, 0, 0);

                    // âœ… ë²”ìœ„ êµì§‘í•© ì„¤ì •
                    slotStart = (slotStart < dayStart) ? dayStart : slotStart;
                    slotEnd = (slotEnd > dayEnd) ? dayEnd : slotEnd;

                    while (slotStart.addMinutes(60) <= slotEnd) {
                        Time next = slotStart.addMinutes(60);

                        // ğŸš« ì ì‹¬ì‹œê°„ ì œì™¸
                        if (
                            (slotStart >= lunchStart && slotStart < lunchEnd) ||
                            (next > lunchStart && next <= lunchEnd)
                        ) {
                            slotStart = next;
                            continue;
                        }

                        TestDriveSlot__c slot = new TestDriveSlot__c(
                            Name = String.valueOf(currentDate)+ ' ' + String.valueOf(slotStart),
                            Date__c = currentDate,
                            DayCode__c = dayCode, // ìš”ì¼ ì €ì¥
                            StartTime__c = slotStart,
                            EndTime__c = next,
                            FlagshipStore__c = store.Id,
                            VehicleModel__c = model.Id,
                            DriveMethod__c = model.DriveMethod__c,
                            AssignedStaff__c = selectedStaff.Id,
                            isAvailable__c = true
                        );

                        System.debug('ê·¼ë¬´ì‹œê°„ - ì‹œì‘: ' + slotStart + ' / ì¢…ë£Œ: ' + slotEnd);

                        slotsToInsert.add(slot);
                        slotStart = next;
                    }
                }
            }
        }

        System.debug('Stores: ' + stores.size());
        System.debug('Models: ' + models.size());
        System.debug('Staff: ' + staffList.size());
        System.debug('Slots to insert: ' + slotsToInsert.size());
        
        if (!slotsToInsert.isEmpty()) {
            insert slotsToInsert;
        }
    }
}

