public with sharing class RepairReservationScheduler {
    public class TimeSlotWrapper {
        @AuraEnabled public String label;
        @AuraEnabled public Integer remaining;
        @AuraEnabled public String startTime;

        public TimeSlotWrapper(String label, Integer remaining, String startTime) {
            this.label = label;
            this.remaining = remaining;
            this.startTime = startTime;
        }
    }

    // âœ… STEP.5 ì‹œê°„ ìŠ¬ë¡¯ ì¡°íšŒ
    @AuraEnabled(cacheable=true)
    public static List<TimeSlotWrapper> getAvailableTimeSlots(Date selectedDate, Id repairShopId) {
        List<TimeSlotWrapper> result = new List<TimeSlotWrapper>();
        String[] weekdays = new List<String>{'ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '};
        Integer dayIndex = (Integer)selectedDate.toStartOfWeek().daysBetween(selectedDate);
        String dayOfWeek = weekdays[dayIndex];

        List<OperatingHours__c> ops = [
            SELECT Id, StartOperation__c, EndOperation__c
            FROM OperatingHours__c
            WHERE OperationRepairShop__c = :repairShopId AND Name = :dayOfWeek
        ];
        if (ops.isEmpty()) return result;

        OperatingHours__c op = ops[0];
        Time startTime = op.StartOperation__c;
        Time endTime = op.EndOperation__c;

        List<WorkingHour__c> working = [
            SELECT SelectTechnician__c
            FROM WorkingHour__c
            WHERE OperationTechnician__c = :op.Id
        ];
        Set<Id> workingTechIds = new Set<Id>();
        for (WorkingHour__c wh : working) {
            workingTechIds.add(wh.SelectTechnician__c);
        }
        if (workingTechIds.isEmpty()) return result;

        DateTime startOfDay = DateTime.newInstance(selectedDate, Time.newInstance(0,0,0,0));
        DateTime endOfDay = DateTime.newInstance(selectedDate, Time.newInstance(23,59,59,0));

        List<Case> existingCases = [
            SELECT Preferred_Date__c, TechnicianPerCase__c
            FROM Case
            WHERE TechnicianPerCase__c IN :workingTechIds
              AND Preferred_Date__c >= :startOfDay AND Preferred_Date__c <= :endOfDay
        ];

        Map<Time, Integer> slotCount = new Map<Time, Integer>();
        for (Case c : existingCases) {
            Time slotTime = Time.newInstance(c.Preferred_Date__c.hour(), c.Preferred_Date__c.minute(), 0, 0);
            slotCount.put(slotTime, slotCount.containsKey(slotTime) ? slotCount.get(slotTime) + 1 : 1);
        }

        for (Time t = startTime; t.addMinutes(90) <= endTime; t = t.addMinutes(90)) {
            if (t >= Time.newInstance(13,0,0,0) && t < Time.newInstance(14,30,0,0)) continue;

            Time tEnd = t.addMinutes(90);
            String label = pad(t.hour()) + ':' + pad(t.minute()) + ' - ' + pad(tEnd.hour()) + ':' + pad(tEnd.minute());
            Integer used = slotCount.containsKey(t) ? slotCount.get(t) : 0;
            Integer remaining = workingTechIds.size() - used;

            result.add(new TimeSlotWrapper(label, remaining, pad(t.hour()) + ':' + pad(t.minute())));
        }
        return result;
    }

    private static String pad(Integer n) {
        return n < 10 ? '0' + String.valueOf(n) : String.valueOf(n);
    }

    // âœ… STEP.3 Picklist ê°’ ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    @AuraEnabled(cacheable=true)
    public static List<Map<String, String>> getServiceDetailsPicklistValues() {
        System.debug('ğŸ” [getServiceDetailsPicklistValues] í˜¸ì¶œë¨');
        
        List<Map<String, String>> results = new List<Map<String, String>>();
        
        try {
            Schema.DescribeFieldResult fieldResult = Case.ServiceReservationTypeDetails__c.getDescribe();
            List<Schema.PicklistEntry> picklistValues = fieldResult.getPicklistValues();
            
            System.debug('ğŸ“‹ ì´ Picklist ê°’ ê°œìˆ˜: ' + picklistValues.size());
            
            for (Schema.PicklistEntry entry : picklistValues) {
                if (entry.isActive()) {
                    System.debug('âœ… í™œì„± ê°’ - Label: "' + entry.getLabel() + '", Value: "' + entry.getValue() + '"');
                    results.add(new Map<String, String>{
                        'label' => entry.getLabel(),
                        'value' => entry.getValue()
                    });
                } else {
                    System.debug('âŒ ë¹„í™œì„± ê°’ - Label: "' + entry.getLabel() + '", Value: "' + entry.getValue() + '"');
                }
            }
        } catch (Exception e) {
            System.debug('âŒ Picklist ì¡°íšŒ ì‹¤íŒ¨: ' + e.getMessage());
        }
        
        System.debug('ğŸ”„ ë°˜í™˜í•  ê²°ê³¼: ' + JSON.serialize(results));
        return results;
    }

    // âœ… STEP.5 ì˜ˆì•½ ë° ê¸°ìˆ ì ë°°ì • (Frontendì—ì„œ ì „ë‹¬ë°›ì€ ê°’ ì‚¬ìš©)
    @AuraEnabled
    public static void assignTechnicianAndCreateCase(
        Id accountId,
        Id repairShopId,
        String preferredDate,
        String selectedDetails,
        String serviceType  // ğŸŸ¡ Frontendì—ì„œ ê³„ì‚°ëœ ê°’ ë°›ê¸°
    ) {
        System.debug('ğŸš€ [assignTechnicianAndCreateCase] ì‹œì‘');
        System.debug('selectedDetails: ' + selectedDetails);
        System.debug('serviceType: ' + serviceType);

        DateTime parsedDateTime;
        try {
            parsedDateTime = DateTime.valueOf(preferredDate);
        } catch (Exception e) {
            throw new AuraHandledException('ë‚ ì§œ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        Case c = new Case(
            AccountId = accountId,
            Repair_Shop__c = repairShopId,
            Preferred_Date__c = parsedDateTime,
            Status = 'New',
            Subject = 'ì •ë¹„ ì˜ˆì•½ - ' + String.valueOf(parsedDateTime.date()),
            ServiceReservationType__c = serviceType, // ğŸŸ¡ Frontendì—ì„œ ì „ë‹¬ë°›ì€ ê°’ ì‚¬ìš©
            ServiceReservationTypeDetails__c = selectedDetails
        );

        try {
            insert c;
            System.debug('âœ… Case ìƒì„± ì„±ê³µ: ' + c.Id);
        } catch (DmlException e) {
            System.debug('âŒ DML ì‹¤íŒ¨: ' + e.getMessage());
            throw new AuraHandledException('ì˜ˆì•½ ì ‘ìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getDmlMessage(0));
        }
    }


}